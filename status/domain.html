<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Domain History</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center" id="domain-name"></h1>
    <p class="text-center mb-4">Showing latest <span id="snapshot-count"></span> snapshots</p>
    <div id="snapshots" class="space-y-4"></div>
    <p class="mt-4 text-center">
      <a href="index.html" class="text-blue-600 hover:underline">‚Üê Back to main status page</a>
    </p>
  </div>

  <script>
    async function getQueryParam(name, defaultValue=null) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || defaultValue;
    }

    async function loadDomainHistory() {
      const domain = await getQueryParam("domain");
      const count = parseInt(await getQueryParam("count", "100"));
      if (!domain) return;

      let config;
      try {
        const configRes = await fetch("config.json?_=" + Date.now());
        config = await configRes.json();
      } catch (err) {
        console.error("Failed to load config.json", err);
        document.getElementById("snapshots").textContent = "Failed to load configuration.";
        return;
      }

      const { github_user, github_repo, github_branch } = config;
      document.getElementById("domain-name").textContent = domain;
      document.getElementById("snapshot-count").textContent = count;

      const container = document.getElementById("snapshots");
      container.innerHTML = "";

      try {
        const apiUrl = `https://api.github.com/repos/${github_user}/${github_repo}/contents/status/history/${domain}?ref=${github_branch}`;
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("Failed to fetch folder contents");

        const files = await res.json();
        const jsonFiles = files
          .filter(f => f.name.endsWith(".json"))
          .sort((a, b) => b.name.localeCompare(a.name))
          .slice(0, count);

        for (const file of jsonFiles) {
          const snapshotRes = await fetch(file.download_url);
          const snapshot = await snapshotRes.json();
          const pre = document.createElement("pre");
          pre.className = "bg-white p-4 rounded shadow overflow-auto";
          pre.textContent = JSON.stringify(snapshot, null, 2);
          container.appendChild(pre);
        }
      } catch (err) {
        console.error(err);
        container.textContent = "Failed to load domain history. Make sure the domain exists and files are pushed.";
      }
    }

    loadDomainHistory();
  </script>
</body>
</html>
