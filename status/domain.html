<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Domain History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/flowbite@1.7.0/dist/flowbite.js"></script>
</head>
<body class="text-gray-900">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center" id="domain-name"></h1>
    <p class="text-center mb-6">Showing latest <span id="snapshot-count"></span> snapshots</p>

    <!-- Status summary -->
    <div id="domain-status" class="mb-6"></div>

    <!-- Sections -->
    <div id="sections" class="space-y-8">
      <div id="http-section">
        <h2 class="text-2xl font-semibold mb-4">24-hour response time</h2>
        <div class="space-y-2" id="http-content"></div>
      </div>
    </div>

    <p class="mt-6 text-center">
      <a href="index.html" class="text-blue-600 hover:underline">‚Üê Back to main status page</a>
    </p>
  </div>

<script>
async function getQueryParam(name, defaultValue = null) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name) || defaultValue;
}

async function loadDomainHistory() {
  const domain = await getQueryParam("domain");
  const count = parseInt(await getQueryParam("count", "288"));
  if (!domain) {
      window.location.href = "index.html";
      return;
  }

  document.title = `Domain History: ${domain}`;
  document.getElementById("domain-name").textContent = domain;
  
  let config;
  try {
    const configRes = await fetch("config.json?_=" + Date.now());
    config = await configRes.json();
  } catch (err) {
    console.error("Failed to load config.json", err);
    document.getElementById("sections").textContent = "Failed to load configuration.";
    return;
  }

  const { github_user, github_repo, github_branch } = config;
  const domainStatusDiv = document.getElementById("domain-status");
  const httpContent = document.getElementById("http-content");
  domainStatusDiv.innerHTML = "";
  httpContent.innerHTML = "";

  try {
    const apiUrl = `https://api.github.com/repos/${github_user}/${github_repo}/contents/status/history/${domain}.json?ref=${github_branch}`;
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error("Failed to fetch domain JSON");

    const file = await res.json();
    const domainData = JSON.parse(atob(file.content)); // GitHub returns base64 content
    const snapshots = domainData.history.slice(-count); // last `count` entries

    if (snapshots.length === 0) {
      domainStatusDiv.innerHTML = `<p class="text-center text-gray-500">No snapshots available for this domain.</p>`;
      return;
    }

    const latest = snapshots[snapshots.length - 1];
    const failedChecks = [];
    if (!latest.http_ok) failedChecks.push("HTTP");
    if (!latest.ssl_ok) failedChecks.push("SSL");
    if (!latest.whois_ok) failedChecks.push("WHOIS");
    
    const isUp = failedChecks.length === 0;
    let statusMessage = isUp ? "No problems detected" :
        (failedChecks.length === 1 ? `${failedChecks[0]} check failed` : `${failedChecks.join(", ")} checks failed`);

    domainStatusDiv.innerHTML = `
      <div class="flex flex-col items-center mb-6">
        <span class="mx-auto inline-flex items-center justify-center rounded-full ${isUp ? 'bg-emerald-100' : 'bg-red-100'} p-4">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" aria-hidden="true" class="${isUp ? 'text-emerald-500' : 'text-red-500'}">
            ${isUp 
              ? '<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM17.4571 9.45711L11 15.9142L6.79289 11.7071L8.20711 10.2929L11 13.0858L16.0429 8.04289L17.4571 9.45711Z"></path>' 
              : '<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM15 9L9 15M9 9L15 15"></path>'}
          </svg>
        </span>
        <h1 class="mt-3 text-lg font-semibold text-gray-900">${statusMessage}</h1>  
        <div class="mt-2 flex flex-wrap items-center gap-2">
          <span class="inline-flex items-center gap-1.5 rounded-md bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-600"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" aria-hidden="true" class="remixicon -ml-0.5 size-4 shrink-0">
            <path d="M18.364 17.364L12 23.7279L5.63604 17.364C2.12132 13.8492 2.12132 8.15076 5.63604 4.63604C9.15076 1.12132 14.8492 1.12132 18.364 4.63604C21.8787 8.15076 21.8787 13.8492 18.364 17.364ZM12 13C13.1046 13 14 12.1046 14 11C14 9.89543 13.1046 9 12 9C10.8954 9 10 9.89543 10 11C10 12.1046 10.8954 13 12 13Z"></path></svg> WHOIS: Expiry ${latest.whois_expiry} | ${latest.whois_ok ? "OK" : "Issue"}</span>
          <span class="inline-flex items-center gap-1.5 rounded-md bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-600"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" aria-hidden="true" class="remixicon -ml-0.5 size-4 shrink-0">
            <path d="M17 7C13.5705 7 10.6449 9.15804 9.50734 12.1903L11.3805 12.8927C12.2337 10.6185 14.4278 9 17 9C17.6983 9 18.3687 9.11928 18.992 9.33857C21.3265 10.16 23 12.3846 23 15C23 18.3137 20.3137 21 17 21H7C3.68629 21 1 18.3137 1 15C1 12.3846 2.67346 10.16 5.00804 9.33857C5.0027 9.22639 5 9.11351 5 9C5 5.13401 8.13401 2 12 2C15.242 2 17.9693 4.20399 18.7652 7.19539C18.1973 7.0675 17.6065 7 17 7Z"></path></svg> SSL: Expiry ${latest.ssl_expiry} | ${latest.ssl_ok ? "OK" : "Issue"}</span>
          <span class="inline-flex items-center gap-1.5 rounded-md bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-600"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" aria-hidden="true" class="remixicon -ml-0.5 size-4 shrink-0">
            <path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM13 12V7H11V14H17V12H13Z"></path></svg> Last run: ${latest.timestamp}</span>
        </div>
      </div>
    `;

    document.getElementById("snapshot-count").textContent = snapshots.length;

    // Build HTTP section as horizontal bar with hover info
    httpContent.innerHTML = ''; // clear previous
    const barContainer = document.createElement('div');
    barContainer.className = "items-center group h-8 mt-3 hidden w-full lg:flex relative";

    snapshots.forEach((s, index) => {
      const segWrapper = document.createElement('div');
      segWrapper.className = "relative size-full overflow-hidden px-[0.5px] transition first:rounded-l-[4px] first:pl-0 last:rounded-r-[4px] last:pr-0 sm:px-px";
    
      const segInner = document.createElement('div');
      segInner.className = "size-full rounded-[1px]";
    
      // Set segment color
      if (s.http_ok) segInner.classList.add('bg-emerald-500', 'dark:bg-emerald-500');
      else if (!s.http_ok && s.http_response_time_ms > 1000) segInner.classList.add('bg-amber-500', 'dark:bg-amber-500');
      else segInner.classList.add('bg-red-500', 'dark:bg-red-500');
    
      // Flowbite tooltip
      const tooltipId = `tooltip-${index}`;
      segInner.setAttribute('data-tooltip-target', tooltipId);
      segInner.setAttribute('data-tooltip-placement', 'top');
    
      const tooltip = document.createElement('div');
      tooltip.id = tooltipId;
      tooltip.role = 'tooltip';
      tooltip.className = "absolute z-50 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-800 rounded-lg shadow-sm opacity-0 transition-opacity duration-300";
      tooltip.innerHTML = `
        <div><strong>${s.date}</strong></div>
        <div>Status: ${s.http_ok ? 'OK' : 'Issue'}</div>
        <div>Response: ${s.http_response_time_ms.toFixed(2)} ms</div>
      `;
    
      segWrapper.appendChild(segInner);
      segWrapper.appendChild(tooltip);
      barContainer.appendChild(segWrapper);
    });


    httpContent.appendChild(barContainer);

  } catch (err) {
    console.error(err);
    document.getElementById("sections").textContent = `Failed to load domain history for ${domain}.`;
  }
}

loadDomainHistory();
</script>
</body>
</html>
