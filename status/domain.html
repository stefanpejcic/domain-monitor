<!DOCTYPE html>
<html lang="en" x-data="domainHistory()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <title>Domain History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-50 p-6">

<p class="mb-2 text-center">
    <a href="index.html" class="text-blue-600 hover:underline">← Back to main status page</a>
</p>
  
<div class="max-w-5xl mx-auto space-y-10">
    <!-- Header -->
    <div class="flex flex-col md:flex-row items-center gap-4">
        <div class="flex justify-center p-4">
            <img :src="screenshotUrl" 
                 class="border-4 border-gray-300 rounded-xl p-2 shadow-lg min-h-[240px] min-w-[400px] max-w-[400px]"
                 alt="Screenshot">
        </div>
        <div class="flex flex-col justify-center w-full">
            <span class="mx-auto inline-flex items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-400/20 p-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-emerald-500">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM17.4571 9.45711L11 15.9142L6.79289 11.7071L8.20711 10.2929L11 13.0858L16.0429 8.04289L17.4571 9.45711Z"></path>
                </svg>
            </span>
            <h1 class="mx-auto inline-flex items-center justify-center mt-3 text-lg font-semibold">
                <a :href="`http://${domain}`" target="_blank" x-text="domain"></a>&nbsp; is &nbsp;<span :class="isUp ? 'text-emerald-600' : 'text-red-600'" x-text="isUp ? 'up!' : 'down!'"></span>
            </h1>
            <p class="text-gray-700 dark:text-gray-300 mt-2" x-html="statusSummary"></p>
        </div>
    </div>

    <!-- Graph -->
    <div class="relative w-full rounded-lg border p-6 shadow-sm bg-white dark:bg-[#090E1A] border-gray-200 dark:border-gray-900">
        <p class="flex justify-between text-sm font-medium mb-3">
            <span class="flex items-center gap-2 font-medium">
                <img :src="`https://www.google.com/s2/favicons?domain=${domain}`" alt="" class="h-4 w-4 rounded-full">
                <span x-text="domain"></span>
            </span>
            <span x-text="uptimePercentage + '% uptime'"></span>
        </p>

        <div class="flex gap-0.5 overflow-x-auto relative" x-ref="graphContainer">
            <template x-for="(entry, index) in history" :key="index">
                <div class="w-2 rounded-[1px] cursor-pointer flex-shrink-0"
                     :class="getColor(entry)"
                     :style="`height: ${Math.min(Math.max(entry.response / 25, 4), 32)}px`"
                     @mouseenter="showTooltip($event, entry)"
                     @mouseleave="hideTooltip()"></div>
            </template>

            <!-- Tooltip -->
            <div x-show="tooltip.show" x-text="tooltip.text"
                 :style="`position: fixed; top: ${tooltip.y}px; left: ${tooltip.x}px; white-space: pre-line;`"
                 class="bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none z-50 transition-opacity"
                 x-transition.opacity></div>
        </div>

        <div class="mt-3 flex items-center justify-between text-sm text-gray-500 dark:text-gray-500">
          <span>First checked: <span x-text="timeAgo(firstChecked)"></span></span>
          <span>Last checked: <span x-text="timeAgo(lastChecked)"></span></span>
        </div>

        <!-- Legend and View Switch -->
        <div class="flex justify-between mt-3">
            <div class="flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-x-2 rounded-md bg-gray-100 px-2 py-0.5 text-sm text-gray-600 dark:bg-gray-800 dark:text-gray-300">
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>Operational</span>
                <span class="inline-flex items-center gap-x-2 rounded-md bg-gray-100 px-2 py-0.5 text-sm text-gray-600 dark:bg-gray-800 dark:text-gray-300">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span>Downtime</span>
                <span class="inline-flex items-center gap-x-2 rounded-md bg-gray-100 px-2 py-0.5 text-sm text-gray-600 dark:bg-gray-800 dark:text-gray-300">
                    <span class="w-2 h-2 rounded-full bg-gray-500"></span>Maintenance</span>
            </div>

            <div class="flex gap-2">
                <button @click="showTable = true; showJSON = false" class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" x-show="!showTable">Table</button>
                <button @click="showJSON = true; showTable = false" class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" x-show="!showJSON">JSON</button>

                <button title="Copy to clipboard"
                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
                    @click="copyLogs($event)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">  <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/></svg>
                </button>

                <button title="Open log in new tab" 
                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
                    @click="openLogsInNewTab()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up-right" viewBox="0 0 16 16">
<path fill-rule="evenodd" d="M14 2.5a.5.5 0 0 0-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z"/>
</svg>
                </button>


              
            </div>
        </div>

        <!-- Table -->
        <div x-show="showTable" x-transition class="mt-4 overflow-x-auto">
            <table class="min-w-full border border-gray-300 dark:border-gray-700 text-sm">
              <thead class="bg-gray-100 dark:bg-gray-800">
                  <tr>
                      <th class="px-3 py-1 border-b border-gray-300 dark:border-gray-700 text-left">Checked</th>
                      <th class="px-3 py-1 border-b border-gray-300 dark:border-gray-700 text-left">Status</th>
                      <th class="px-3 py-1 border-b border-gray-300 dark:border-gray-700 text-left">Response (ms)</th>
                      <!--th class="px-3 py-1 border-b border-gray-300 dark:border-gray-700 text-left">WHOIS</th>
                      <th class="px-3 py-1 border-b border-gray-300 dark:border-gray-700 text-left">SSL</th-->
                      <th class="px-3 py-1 border-b border-gray-300 dark:border-gray-700 text-left">Up?</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(entry, index) in [...history].slice().reverse()" :key="index">
                      <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800">
                          <td class="px-3 py-1" x-text="entry.time"></td>
                          <td class="px-3 py-1">
                              <span :class="`inline-flex items-center gap-x-1 whitespace-nowrap px-2 py-1 text-xs font-medium ring-1 ring-inset rounded-full ${statusColor(entry.statusCode).bg} ${statusColor(entry.statusCode).text} ${statusColor(entry.statusCode).ring}`">
                                  <span :class="`w-1.5 h-1.5 shrink-0 rounded-full ${statusColor(entry.statusCode).dot}`" aria-hidden="true"></span>
                                  <span x-text="entry.statusCode"></span>
                              </span>
                          </td>
                          <td class="px-3 py-1" x-text="entry.response"></td>
                          <!--td class="px-3 py-1 relative" @mouseenter="showTooltip($event, {text: entry.whois_ok ? 'OK' : 'Expiring Soon', extra: 'Expiry: ' + entry.whois_expiry})" @mouseleave="hideTooltip()">
                              <span x-text="entry.whois_ok ? 'OK' : 'Issue'"></span>
                          </td>
                          <td class="px-3 py-1 relative"  @mouseenter="showTooltip($event, {text: entry.ssl_ok ? 'Valid' : 'Expiring', extra: 'Expiry: ' + entry.ssl_expiry})"  @mouseleave="hideTooltip()">
                              <span x-text="entry.ssl_ok ? 'Valid' : 'X'"></span>
                      </td-->
                          <td class="px-3 py-1 flex items-center gap-1">
                              <span x-html="entry.up ? '&#10003;' : '&#10007;'"></span>
                              <span x-text="entry.up ? 'Yes' : 'No'"></span>
                          </td>
                      </tr>
                  </template>
                </tbody>
            </table>
        </div>

        <!-- JSON -->
        <div x-show="showJSON" x-transition class="mt-4">
            <pre class="bg-gray-100 dark:bg-gray-800 p-3 rounded text-xs overflow-x-auto" x-text="JSON.stringify(history, null, 2)"></pre>
        </div>
    </div>
</div>


<script>
function domainHistory() {
    return {
        domain: '',
        screenshotUrl: '',
        history: [],
        tooltip: { show: false, text: "", x: 0, y: 0 },
        showTable: true,
        showJSON: false,
        isUp: true,
        uptimePercentage: 0,
        firstChecked: '',
        lastChecked: '',
        statusSummary: '',

        async init() {
            try {
                const domainParam = new URLSearchParams(window.location.search).get('domain');
                if (!domainParam) {
                    window.location.href = "index.html";
                    return;
                }

                this.domain = domainParam;
                this.screenshotUrl = `https://screenshots-v2.openpanel.com/api/screenshot/${this.domain}`;

                const res = await fetch(`history/${this.domain}.json`);
                if (!res.ok) throw new Error("Failed to load domain JSON");

                const data = await res.json();
                this.history = (data.history || []).map(e => ({
                    time: e.timestamp,
                    statusCode: e.http_status,
                    response: parseFloat(e.http_response_time_ms.toFixed(2)),
                    up: e.http_ok,
                    whois_ok: e.whois_ok,
                    whois_expiry: e.whois_expiry,
                    ssl_ok: e.ssl_ok,
                    ssl_expiry: e.ssl_expiry
                }));

                if (this.history.length > 0) {
                    this.isUp = this.history[this.history.length - 1].up;

                    const totalChecks = this.history.length;
                    const outages = this.history.filter(e => !e.up).length;
                    const avgResponse = (this.history.reduce((sum, e) => sum + e.response, 0) / totalChecks).toFixed(2);
                    this.firstChecked = this.history[0].time;
                    this.lastChecked = this.history[this.history.length - 1].time;
                    this.uptimePercentage = (((totalChecks - outages) / totalChecks) * 100).toFixed(2);

                    this.statusSummary = `
                        Website was checked <strong>${totalChecks}</strong> times.
                        <br>There were ${outages === 0 ? 'no' : `<strong>${outages}</strong>`} outages.
                        <br>Average response time: <strong>${avgResponse} ms</strong>.
                    `;
                }
            } catch (err) {
                console.error('Failed to load domain history', err);
                this.statusSummary = "Failed to load domain history.";
            }
        },

        // format to human readable date
        timeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffSec = Math.floor((now - past) / 1000);
        
            if (diffSec < 60) return `${diffSec} sec ago`;
            const diffMin = Math.floor(diffSec / 60);
            if (diffMin < 60) return `${diffMin} min ago`;
            const diffHour = Math.floor(diffMin / 60);
            if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
            const diffDay = Math.floor(diffHour / 24);
            return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
        },

        statusColor(code) {
            if (code >= 200 && code <= 299) return { bg: "bg-emerald-50 dark:bg-emerald-400/10", text: "text-emerald-900 dark:text-emerald-400", ring: "ring-emerald-600/30 dark:ring-emerald-400/20", dot: "bg-emerald-600 dark:bg-emerald-400" };
            if (code >= 300 && code <= 399) return { bg: "bg-orange-50 dark:bg-orange-400/10", text: "text-orange-900 dark:text-orange-400", ring: "ring-orange-600/30 dark:ring-orange-400/20", dot: "bg-orange-600 dark:bg-orange-400" };
            if (code >= 400 && code <= 499) return { bg: "bg-black dark:bg-gray-800", text: "text-white dark:text-gray-50", ring: "ring-gray-800/50 dark:ring-gray-700/50", dot: "bg-black dark:bg-gray-500" };
            if (code >= 500) return { bg: "bg-red-50 dark:bg-red-400/10", text: "text-red-900 dark:text-red-400", ring: "ring-red-600/30 dark:ring-red-400/20", dot: "bg-red-600 dark:bg-red-400" };
            return { bg: "bg-gray-100 dark:bg-gray-700/10", text: "text-gray-900 dark:text-gray-200", ring: "ring-gray-300/30 dark:ring-gray-500/20", dot: "bg-gray-400 dark:bg-gray-600" };
        },

        getColor(entry) {
            if (entry.response > 3000) return "bg-orange-500";
            return (entry.statusCode >= 200 && entry.statusCode < 500) ? "bg-emerald-500" : "bg-red-500";
        },

        showTooltip(e, entry) {
            this.tooltip.show = true;
            if(entry.time){ 
                const dateTime = new Date(entry.time).toLocaleString();
                this.tooltip.text = `${dateTime}\nStatus: ${entry.statusCode} | Response: ${entry.response.toFixed(2)} ms`;
            } else {
                this.tooltip.text = `${entry.text}${entry.extra ? '\n' + entry.extra : ''}`;
            }
            this.tooltip.x = e.clientX + 10;
            this.tooltip.y = e.clientY + 10;
        },

        hideTooltip() {
            this.tooltip.show = false;
        },

        copyLogs(event) {
            const logsText = JSON.stringify(this.history, null, 2);
            navigator.clipboard.writeText(logsText)
                .then(() => {
                    const btn = event.currentTarget;
                    const rect = btn.getBoundingClientRect();
                    this.tooltip.text = "Copied!";
                    this.tooltip.show = true;
                    this.tooltip.x = rect.left + rect.width / 2;
                    this.tooltip.y = rect.top - 30; // above the button
                    setTimeout(() => this.tooltip.show = false, 1000);
                })
                .catch(err => {
                    this.tooltip.text = "Failed to copy";
                    this.tooltip.show = true;
                    setTimeout(() => this.tooltip.show = false, 1500);
                });
        },
        
        openLogsInNewTab() {
            window.open(`history/${this.domain}.json`, '_blank');
        }

      
    }
}
</script>

<small class="mt-4 text-center" x-show="domain">⚡ Subscribe via RSS — <a href="../index.xml" target="_blank" class="no-underline">to all updates</a> or <a :href="`${domain}.xml`" target="_blank" class="no-underline"> only this feed (<span x-text="domain"></span>)</a></small>

</body>
</html>
